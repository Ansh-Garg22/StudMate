<!DOCTYPE html>
<html>
  <head>
    <title>Chat Room</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
      * {
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #eeeeee;
      }
      .container {
        width: 170vh;
        height: 85vh;
        padding: 18px;
        display: flex;
        border-radius: 4px;
        margin: 30px auto;
        background-color: white;
      }
      .right {
        width: 70%;
        position: relative;
      }
      .left {
        border-right: 2px solid rgba(72, 71, 71, 0.538);
        background-color: #EEEEEE;
        width: 30%;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        padding-left: 20px;
      }

      .box {
        display: flex;
        align-items: center;
        width: 85%;
        padding-inline-start: 10px;
        gap: 1.2rem;
      }
      .box:hover {
        background-color: #dddddd;
        cursor: pointer;
      }
      .box img {
        width: 50px;
        height: 50px;
      }
      #messages {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        max-height: 460px;
        overflow-y: auto;
        padding-inline: 20px;
      }
      #messages::-webkit-scrollbar {
        display: none;
      }
      .message {
        margin-bottom: 10px;
        border-radius: 10px;
        padding: 5px 10px;
        font-size: 1.1rem;
        display: flex;
        flex-direction: column;
      }

      .message-header {
        display: flex;
        align-items: center;
        font-size: 1rem;
        color: #1b1a1a;
        margin-bottom: 4px;
      }
      .message-header span {
        padding-inline: 3px;
      }
      .message-content {
        font-size: 1.1rem;
        padding: 8px 12px;
        max-width: 300px;
      }

      .message--self .message-content {
        background-color: #dcf8c6;
        border-radius: 15px 6px 15px 10px;
        align-self: flex-end;
      }

      .message--other .message-content {
        background-color: #e2e2e2;
        border-radius: 6px 15px 10px;
        align-self: flex-start;
      }
      .message--self .message-header {
        align-self: flex-end;
      }
      .message--other .message-header {
        align-self: flex-start;
      }
      .send-btn {
        font-size: 1.1rem;
        padding: 4px;
        margin-top: 15px;
        margin-inline-start: 8px;
      }
      i {
        font-size: 2rem;
        margin-top: 15px;
        margin-left: 20px;
      }
      .right .head {
        height: 76px;
        display: flex;
        box-shadow: 0px 15px 10px -15px #1111113a;
        align-items: center;
      }
      .right img {
        width: 50px;
        height: 50px;
        margin-left: 30px;
      }
      input {
        font-size: 1.2rem;
        padding: 5px;
        width: 650px;
        border-radius: 4px;
        margin-top: 15px;
      }
      .input-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left">
        <div>
          <br />
        </div>
        <div class="box">
          <img src="/css/images/user.png" alt="" />
          <h3 style="font-size: 1.5rem">Ansh Garg</h3>
        </div>
        <div class="box">
          <img src="/css/images/user.png" alt="" />
          <h3 style="font-size: 1.5rem">Ansh Garg</h3>
        </div>
      </div>
      <div class="right">
        <div class="head">
          <img src="/css/images/user.png" alt="" />
          <h1 style="margin-left: 10px">Welcome, <%= user.name %></h1>
        </div>
        <div id="messages"></div>
        <div class="input-container">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
          />
          <i
            class="fa-solid fa-paper-plane"
            class="send-btn"
            onclick="sendMessage()"
          ></i>
        </div>
      </div>
    </div>
    <a href="/chatlogout"><button>Logout</button></a>
    <!-- Include moment.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const userId = "<%= user._id %>"; // Get user ID from server-side
      const username = "<%= user.name %>";
      socket.on("connect", () => {
        console.log("Connected to server");
        socket.emit("join-room", userId); // Send user ID to join room
        getInitialMessages(); // Get initial messages when connected
      });

      socket.on("new-message", (message) => {
        const messagesContainer = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.classList.add("message"); // Add a base class for styling

        const messageHeader = document.createElement("div");
        messageHeader.classList.add("message-header");
        const usernameElement = document.createElement("span");
        usernameElement.textContent = message.sender.username;
        const timestampElement = document.createElement("span");
        timestampElement.textContent = moment(message.timestamp).format("LT"); // Change the format to show only the time
        messageHeader.appendChild(usernameElement);
        messageHeader.appendChild(timestampElement);

        const contentElement = document.createElement("div");
        contentElement.classList.add("message-content");
        contentElement.textContent = message.content;

        messageElement.appendChild(messageHeader);
        messageElement.appendChild(contentElement);

        if (message.sender._id === userId) {
          messageElement.classList.add("message--self");
        } else {
          messageElement.classList.add("message--other");
        }

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });

      async function getInitialMessages() {
        try {
          const response = await fetch("/get-messages");
          const messages = await response.json();
          const messagesContainer = document.getElementById("messages");

          const reversedMessages = messages.slice().reverse();
          reversedMessages.forEach((message) => {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");

            const messageHeader = document.createElement("div");
            messageHeader.classList.add("message-header");
            const usernameElement = document.createElement("span");
            usernameElement.textContent = message.sender.name;
            const timestampElement = document.createElement("span");
            timestampElement.textContent = moment(message.timestamp).format(
              "LT"
            ); // Change the format to show only the time

            messageHeader.appendChild(usernameElement);
            messageHeader.appendChild(timestampElement);

            const contentElement = document.createElement("div");
            contentElement.classList.add("message-content");
            contentElement.textContent = message.content;

            messageElement.appendChild(messageHeader);
            messageElement.appendChild(contentElement);

            if (message.sender._id === userId) {
              messageElement.classList.add("message--self");
            } else {
              messageElement.classList.add("message--other");
            }

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          });
        } catch (error) {
          console.error("Error fetching messages:", error);
        }
      }
      function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const content = messageInput.value.trim();

        if (content) {
          socket.emit("send-message", {
            content: content,
            senderId: userId,
            sendername: username, // Send user ID along with the message
          });
          messageInput.value = "";
        }
      }
    </script>
  </body>
</html>
